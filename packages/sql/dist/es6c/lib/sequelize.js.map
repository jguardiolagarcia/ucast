{"version":3,"file":"sequelize.js","sources":["../../../src/lib/sequelize.ts"],"sourcesContent":["import { Condition } from '@ucast/core';\nimport { ModelStatic, Utils, literal } from 'sequelize';\nimport {\n  createSqlInterpreter,\n  allInterpreters,\n  SqlOperator,\n  createDialects,\n  mysql\n} from '../index';\n\nconst hasOwn = Object.hasOwn ||\n  Object.prototype.hasOwnProperty.call.bind(Object.prototype.hasOwnProperty);\n\nfunction joinRelation(relationName: string, Model: ModelStatic<any>) {\n  return hasOwn(Model.associations, relationName);\n}\n\nconst dialects = createDialects({\n  joinRelation,\n  paramPlaceholder: mysql.paramPlaceholder,\n});\n\nexport function createInterpreter(interpreters: Record<string, SqlOperator<any>>) {\n  const interpretSQL = createSqlInterpreter(interpreters);\n\n  return (condition: Condition, Model: ModelStatic<any>) => {\n    const dialect = Model.sequelize!.getDialect() as keyof typeof dialects;\n    const options = dialects[dialect];\n\n    if (!options) {\n      throw new Error(`Unsupported database dialect: ${dialect}`);\n    }\n\n    const [sql, params, joins] = interpretSQL(condition, options, Model);\n    return {\n      include: joins.map(association => ({ association, required: true })),\n      where: literal(Utils.format([sql, ...(params as string[])], dialect)),\n    };\n  };\n}\n\nexport const interpret = createInterpreter(allInterpreters);\n"],"names":["hasOwn","Object","prototype","hasOwnProperty","call","bind","joinRelation","relationName","Model","associations","dialects","createDialects","paramPlaceholder","mysql","createInterpreter","interpreters","interpretSQL","createSqlInterpreter","condition","dialect","sequelize","getDialect","options","Error","sql","params","joins","include","map","association","required","where","literal","Utils","format","interpret","allInterpreters"],"mappings":";;;;;;;AAUA,MAAMA,MAAM,GAAGC,MAAM,CAACD,MAAP,IACbC,MAAM,CAACC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCC,IAArC,CAA0CJ,MAAM,CAACC,SAAP,CAAiBC,cAA3D,CADF;;AAGA,SAASG,YAAT,CAAsBC,YAAtB,EAA4CC,KAA5C,EAAqE;AACnE,SAAOR,MAAM,CAACQ,KAAK,CAACC,YAAP,EAAqBF,YAArB,CAAb;AACD;;AAED,MAAMG,QAAQ,GAAGC,oBAAc,CAAC;AAC9BL,EAAAA,YAD8B;AAE9BM,EAAAA,gBAAgB,EAAEC,WAAK,CAACD;AAFM,CAAD,CAA/B;AAKO,SAASE,iBAAT,CAA2BC,YAA3B,EAA2E;AAChF,QAAMC,YAAY,GAAGC,0BAAoB,CAACF,YAAD,CAAzC;AAEA,SAAO,CAACG,SAAD,EAAuBV,KAAvB,KAAmD;AACxD,UAAMW,OAAO,GAAGX,KAAK,CAACY,SAAN,CAAiBC,UAAjB,EAAhB;AACA,UAAMC,OAAO,GAAGZ,QAAQ,CAACS,OAAD,CAAxB;;AAEA,QAAI,CAACG,OAAL,EAAc;AACZ,YAAM,IAAIC,KAAJ,CAAW,iCAAgCJ,OAAQ,EAAnD,CAAN;AACD;;AAED,UAAM,CAACK,GAAD,EAAMC,MAAN,EAAcC,KAAd,IAAuBV,YAAY,CAACE,SAAD,EAAYI,OAAZ,EAAqBd,KAArB,CAAzC;AACA,WAAO;AACLmB,MAAAA,OAAO,EAAED,KAAK,CAACE,GAAN,CAAUC,WAAW,KAAK;AAAEA,QAAAA,WAAF;AAAeC,QAAAA,QAAQ,EAAE;AAAzB,OAAL,CAArB,CADJ;AAELC,MAAAA,KAAK,EAAEC,iBAAO,CAACC,eAAK,CAACC,MAAN,CAAa,CAACV,GAAD,EAAM,GAAIC,MAAV,CAAb,EAA6CN,OAA7C,CAAD;AAFT,KAAP;AAID,GAbD;AAcD;MAEYgB,SAAS,GAAGrB,iBAAiB,CAACsB,qBAAD;;;;;"}