{"version":3,"file":"objection.js","sources":["../../../src/lib/objection.ts"],"sourcesContent":["import { Condition } from '@ucast/core';\nimport { Model, QueryBuilder } from 'objection';\nimport {\n  createSqlInterpreter,\n  allInterpreters,\n  SqlOperator,\n  createDialects,\n  mysql,\n} from '../index';\n\nfunction joinRelation(relationName: string, query: QueryBuilder<Model>) {\n  if (!query.modelClass().getRelation(relationName)) {\n    return false;\n  }\n\n  query.joinRelated(relationName);\n  return true;\n}\n\nconst dialects = createDialects({\n  joinRelation,\n  paramPlaceholder: mysql.paramPlaceholder,\n});\n\nexport function createInterpreter(interpreters: Record<string, SqlOperator<any>>) {\n  const interpretSQL = createSqlInterpreter(interpreters);\n  return <T extends Model>(condition: Condition, query: QueryBuilder<T>) => {\n    const dialect = query.modelClass().knex().client.config.client as keyof typeof dialects;\n    const options = dialects[dialect];\n\n    if (!options) {\n      throw new Error('Unsupported database dialect');\n    }\n\n    const [sql, params] = interpretSQL(condition, options, query);\n    return query.whereRaw(sql, params);\n  };\n}\n\nexport const interpret = createInterpreter(allInterpreters);\n"],"names":["joinRelation","relationName","query","modelClass","getRelation","joinRelated","dialects","createDialects","paramPlaceholder","mysql","createInterpreter","interpreters","interpretSQL","createSqlInterpreter","condition","dialect","knex","client","config","options","Error","sql","params","whereRaw","interpret","allInterpreters"],"mappings":";;;;;;AAUA,SAASA,YAAT,CAAsBC,YAAtB,EAA4CC,KAA5C,EAAwE;AACtE,MAAI,CAACA,KAAK,CAACC,UAAN,GAAmBC,WAAnB,CAA+BH,YAA/B,CAAL,EAAmD;AACjD,WAAO,KAAP;AACD;;AAEDC,EAAAA,KAAK,CAACG,WAAN,CAAkBJ,YAAlB;AACA,SAAO,IAAP;AACD;;AAED,MAAMK,QAAQ,GAAGC,oBAAc,CAAC;AAC9BP,EAAAA,YAD8B;AAE9BQ,EAAAA,gBAAgB,EAAEC,WAAK,CAACD;AAFM,CAAD,CAA/B;AAKO,SAASE,iBAAT,CAA2BC,YAA3B,EAA2E;AAChF,QAAMC,YAAY,GAAGC,0BAAoB,CAACF,YAAD,CAAzC;AACA,SAAO,CAAkBG,SAAlB,EAAwCZ,KAAxC,KAAmE;AACxE,UAAMa,OAAO,GAAGb,KAAK,CAACC,UAAN,GAAmBa,IAAnB,GAA0BC,MAA1B,CAAiCC,MAAjC,CAAwCD,MAAxD;AACA,UAAME,OAAO,GAAGb,QAAQ,CAACS,OAAD,CAAxB;;AAEA,QAAI,CAACI,OAAL,EAAc;AACZ,YAAM,IAAIC,KAAJ,CAAU,8BAAV,CAAN;AACD;;AAED,UAAM,CAACC,GAAD,EAAMC,MAAN,IAAgBV,YAAY,CAACE,SAAD,EAAYK,OAAZ,EAAqBjB,KAArB,CAAlC;AACA,WAAOA,KAAK,CAACqB,QAAN,CAAeF,GAAf,EAAoBC,MAApB,CAAP;AACD,GAVD;AAWD;MAEYE,SAAS,GAAGd,iBAAiB,CAACe,qBAAD;;;;;"}