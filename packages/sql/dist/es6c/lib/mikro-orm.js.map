{"version":3,"file":"mikro-orm.js","sources":["../../../src/lib/mikro-orm.ts"],"sourcesContent":["import { Condition } from '@ucast/core';\nimport { QueryBuilder, AnyEntity, EntityMetadata } from 'mikro-orm';\nimport {\n  createSqlInterpreter,\n  allInterpreters,\n  SqlOperator,\n  createDialects,\n  mysql\n} from '../index';\n\nfunction joinRelation<T extends AnyEntity<T>>(relationName: string, query: QueryBuilder<T>) {\n  const privateQuery = query as any;\n  const meta = privateQuery.metadata.get(privateQuery.entityName) as EntityMetadata<T>;\n  const prop = meta.properties[relationName as keyof T & string];\n\n  if (prop && prop.reference) {\n    query.join(`${query.alias}.${relationName}`, relationName);\n    return true;\n  }\n\n  return false;\n}\n\nconst dialects = createDialects({\n  joinRelation,\n  paramPlaceholder: mysql.paramPlaceholder,\n});\n\nexport function createInterpreter(interpreters: Record<string, SqlOperator<any>>) {\n  const interpretSQL = createSqlInterpreter(interpreters);\n\n  return <T extends AnyEntity<T>>(condition: Condition, query: QueryBuilder<T>) => {\n    const dialect = (query as any).driver.config.get('type') as keyof typeof dialects;\n    const options = dialects[dialect];\n\n    if (!options) {\n      throw new Error(`Unsupported database dialect: ${dialect}`);\n    }\n\n    const [sql, params] = interpretSQL(condition, options, query);\n    return query.where(sql, params);\n  };\n}\n\nexport const interpret = createInterpreter(allInterpreters);\n"],"names":["joinRelation","relationName","query","privateQuery","meta","metadata","get","entityName","prop","properties","reference","join","alias","dialects","createDialects","paramPlaceholder","mysql","createInterpreter","interpreters","interpretSQL","createSqlInterpreter","condition","dialect","driver","config","options","Error","sql","params","where","interpret","allInterpreters"],"mappings":";;;;;;AAUA,SAASA,YAAT,CAA8CC,YAA9C,EAAoEC,KAApE,EAA4F;AAC1F,QAAMC,YAAY,GAAGD,KAArB;AACA,QAAME,IAAI,GAAGD,YAAY,CAACE,QAAb,CAAsBC,GAAtB,CAA0BH,YAAY,CAACI,UAAvC,CAAb;AACA,QAAMC,IAAI,GAAGJ,IAAI,CAACK,UAAL,CAAgBR,YAAhB,CAAb;;AAEA,MAAIO,IAAI,IAAIA,IAAI,CAACE,SAAjB,EAA4B;AAC1BR,IAAAA,KAAK,CAACS,IAAN,CAAY,GAAET,KAAK,CAACU,KAAM,IAAGX,YAAa,EAA1C,EAA6CA,YAA7C;AACA,WAAO,IAAP;AACD;;AAED,SAAO,KAAP;AACD;;AAED,MAAMY,QAAQ,GAAGC,oBAAc,CAAC;AAC9Bd,EAAAA,YAD8B;AAE9Be,EAAAA,gBAAgB,EAAEC,WAAK,CAACD;AAFM,CAAD,CAA/B;AAKO,SAASE,iBAAT,CAA2BC,YAA3B,EAA2E;AAChF,QAAMC,YAAY,GAAGC,0BAAoB,CAACF,YAAD,CAAzC;AAEA,SAAO,CAAyBG,SAAzB,EAA+CnB,KAA/C,KAA0E;AAC/E,UAAMoB,OAAO,GAAIpB,KAAD,CAAeqB,MAAf,CAAsBC,MAAtB,CAA6BlB,GAA7B,CAAiC,MAAjC,CAAhB;AACA,UAAMmB,OAAO,GAAGZ,QAAQ,CAACS,OAAD,CAAxB;;AAEA,QAAI,CAACG,OAAL,EAAc;AACZ,YAAM,IAAIC,KAAJ,CAAW,iCAAgCJ,OAAQ,EAAnD,CAAN;AACD;;AAED,UAAM,CAACK,GAAD,EAAMC,MAAN,IAAgBT,YAAY,CAACE,SAAD,EAAYI,OAAZ,EAAqBvB,KAArB,CAAlC;AACA,WAAOA,KAAK,CAAC2B,KAAN,CAAYF,GAAZ,EAAiBC,MAAjB,CAAP;AACD,GAVD;AAWD;MAEYE,SAAS,GAAGb,iBAAiB,CAACc,qBAAD;;;;;"}